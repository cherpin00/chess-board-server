<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Chess Engine</title>
		<link
			rel="stylesheet"
			href="{{url_for('static', filename='css/chessboard-1.0.0.min.css')}}"
		/>
		<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
		<script src="{{url_for('static', filename='js/chessboard-1.0.0.min.js')}}"></script>
	</head>
	<body>
		<div id="myBoard" style="width: 400px"></div>
		<button id="startBtn">Start Position</button>
		<button id="clearBtn">Clear Board</button>
		<script>
			// source: https://github.com/oakmac/chessboardjs/blob/master/examples/5000-legal-moves.example
			// var fen = "{{ fen }}";
			// if (!fen) {
			// 	fen = "start";
			// }
			var board = null;
			var game = new Chess();
			var $status = $("#status");
			var $fen = $("#fen");
			var $pgn = $("#pgn");
			function updateStatus() {
				var status = "";

				var moveColor = "White";
				if (game.turn() === "b") {
					moveColor = "Black";
				}

				// checkmate?
				if (game.in_checkmate()) {
					status = "Game over, " + moveColor + " is in checkmate.";
				}

				// draw?
				else if (game.in_draw()) {
					status = "Game over, drawn position";
				}

				// game still on
				else {
					status = moveColor + " to move";

					// check?
					if (game.in_check()) {
						status += ", " + moveColor + " is in check";
					}
				}

				$status.html(status);
				$fen.html(game.fen());
				$pgn.html(game.pgn());
			}
			function onChange() {
				console.log("Board changed: ", board.fen());
				$.ajax({
					type: "POST",
					contentType: "application/json",
					data: JSON.stringify({ fen: board.fen() }),
					url: "/updateBoard",
				});
			}
			function onDragStart(source, piece, position, orientation) {
				// do not pick up pieces if the game is over
				if (game.game_over()) return false;

				// only pick up pieces for the side to move
				if (
					(game.turn() === "w" && piece.search(/^b/) !== -1) ||
					(game.turn() === "b" && piece.search(/^w/) !== -1)
				) {
					return false;
				}
			}

			function onDrop(source, target) {
				// see if the move is legal
				var move = game.move({
					from: source,
					to: target,
					promotion: "q", // NOTE: always promote to a queen for example simplicity
				});

				// illegal move
				if (move === null) return "snapback";

				updateStatus();
			}

			function onSnapEnd() {
				board.position(game.fen());
			}

			var config = {
				position: fen,
				sparePieces: true,
				draggable: true,
				onChange: onChange,
				onDrop: onDrop,
				onSnapEnd: onSnapEnd,
				onDragStart: onDragStart,
			};
			var board = Chessboard("myBoard", config);

			updateStatus();

			$("#startBtn").on("click", board.start);
			$("#clearBtn").on("click", board.clear);
		</script>
	</body>
</html>
